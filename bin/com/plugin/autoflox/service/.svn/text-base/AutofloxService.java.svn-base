package com.plugin.autoflox.service;

import java.io.FileInputStream;
import java.io.IOException;

import org.apache.commons.io.IOUtils;

import com.plugin.autoflox.service.aji.DumpFileThread;
import com.plugin.autoflox.service.aji.JSASTModifierWrapper;
import com.plugin.autoflox.service.aji.executiontracer.AstInstrumenter;

public class AutofloxService extends Thread {

	public static String jsSourcePath = "/home/cclinus/workspace/webTest/WebContent/ex.js";
	public static String dumpFilePath = "/home/cclinus/workspace/proxy/instrumented/dump_data";
	public static String jsSourceName = "ex.js";

	public void run() {
		// Instrumentation
		JSASTModifierWrapper modifierWrapper = new JSASTModifierWrapper(
				new AstInstrumenter());
		modifierWrapper.setInstrumentAsyncs(false);

		try {
			System.err.println("Service Thread starts");
			
			String jsSource;
			FileInputStream inputStream = new FileInputStream(jsSourcePath);
			try {
				jsSource = IOUtils.toString(inputStream);
			} finally {
				inputStream.close();
			}
			modifierWrapper.startInstrumentation(jsSource, jsSourceName);

			// Start a thread that read and clean dump_file
			new DumpFileThread(dumpFilePath).start();
		} catch (IOException e) {

		}
	}
}
